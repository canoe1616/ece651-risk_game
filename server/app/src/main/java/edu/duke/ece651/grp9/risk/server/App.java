/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package edu.duke.ece651.grp9.risk.server;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.HashSet;
import java.util.Iterator;

import edu.duke.ece651.grp9.risk.shared.*;
//import edu.duke.ece651.grp9.risk.shared.MapPackage;
//import edu.duke.ece651.grp9.risk.shared.Message;


public class App {
  private static HashSet<String> remainingColors;
  public App() {
    remainingColors = new HashSet<>();
  }

  public App(Map m){
    remainingColors = new HashSet<>();
    Iterator<Player> it = m.getPlayer().iterator();
    while(it.hasNext()){
      remainingColors.add(it.next().getName());
    }
    
  }
  

  public void selectColor(ObjectOutputStream stream) {
    StringBuilder sb = new StringBuilder();
    sb.append("Please select what color you would like to play as: ");
    for (String color : remainingColors) {
      sb.append(color + " ");
    }
    try {
      stream.writeObject(sb.toString());
    } catch(Exception e) {
      System.out.println(e);
    }
  }
  
  public boolean deleteColor(String color){
    for (String c : remainingColors) {
      if(c.equals(color)){
        remainingColors.remove(color);
        return true;
      }
    }
    return false;
  }


  public void unitSetting(ObjectOutputStream stream, Player player){

    StringBuilder sb = new StringBuilder();
    sb.append("You have " + player.getTerritoryNumber()+ " territories: ");
    for(Territory ter : player.getTerritoryList()){
      sb.append(ter.getName()+ " ");
    }
    sb.append("\n");
    sb.append("You have 30 total units, how do you want to place the units?");
    try {
      stream.writeObject(sb.toString());
    } catch(Exception e) {
      System.out.println(e);
    }
  }

  public Player findPlayer(String color, Map m){
    HashSet<Player> list = m.getPlayer();
    Iterator<Player> it = list.iterator();
    while(it.hasNext()){
      Player pyr = it.next();
      if(pyr.getName().equals(color)){
        return pyr;
      }
     }
    return null;
  }

  //boolean
  public static void main(String[] args) {
    
    MapFactory f = new MapFactory();
    Map m = f.makeMapForThree();
    int player_num = 3;
    App app = new App(m);
 
    try(ServerSocket ss = new ServerSocket(6666)){
      
    for(int i=0; i<player_num; i++){
      //add the checker
      ActionRuleChecker tmp = new ActionRuleChecker();


      Socket socket = ss.accept();
      //send map object
      OutputStream outputStream = socket.getOutputStream();
      ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream);
      objectOutputStream.writeObject(m);

      InputStream inputStream = socket.getInputStream();
      ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);
      
      app.selectColor(objectOutputStream);
      //check if the color selection is valid
      String color = "";
      while(true){

        //boolean for color checking

      String color_correct = "true";
      //InputStream inputStream = socket.getInputStream();
      //ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);
      color = (String)objectInputStream.readObject();

      // add the checker
        //if everything is good, we will send "true" to the client

      //System.out.println(color);
      while(tmp.checkColor(color, remainingColors) != null){

        //System.out.println(tmp.checkColor(color, remainingColors));
        color_correct = "false";
        
        objectOutputStream.writeObject("false");

        //read the new color from the client
        color = (String)objectInputStream.readObject();
        }

      if(tmp.checkColor(color, remainingColors) == null) {
        color_correct = "true";
          objectOutputStream.writeObject(color_correct);
           app.deleteColor(color);
           break;
      }
      }
      //read unit assignment
      app.unitSetting(objectOutputStream, app.findPlayer(color, m));
      String unitString = "";
      while(true){
        String unit_correct = "true";
        //InputStream inputStream = socket.getInputStream();
        //ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);

        unitString = (String)objectInputStream.readObject();
        System.out.print(unitString);
        // add the checker
        while(tmp.checkUnit(unitString, app.findPlayer(color, m)) != null){
          System.out.print(unitString);
          unit_correct = "false";
          objectOutputStream.writeObject("false");
          unitString = (String)objectInputStream.readObject();

        }
        //
        
        if(tmp.checkUnit(unitString, app.findPlayer(color, m)) == null) {
           unit_correct = "true";
           objectOutputStream.writeObject(unit_correct);
           break;
        }
      }
      
      socket.close();
      }
    ss.close();
  }
    catch(Exception e){
      System.out.println(e);
    }
  }
};
